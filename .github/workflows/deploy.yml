name: Build and Release macOS App

# TODO: workflow_dispatchに変更する
on:
  pull_request:
    types: [opened, synchronize]

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "setup java"
        uses: actions/setup-java@v3
        with:
          distribution: "zulu"
          java-version: "12.x"

      - uses: ./.github/actions/install_flutter_dependencies

      - name: "Install codemagic-cli-tools"
        run: |
          pip3 install codemagic-cli-tools

      - name: "codemagic cli tools version"
        run: |
          codemagic-cli-tools --version

      - name: "Install the Apple certificate"
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
        run: |
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH
          openssl pkcs12 -in $CERTIFICATE_PATH -nodes -nocerts -password pass:$P12_PASSWORD | openssl rsa -out $RUNNER_TEMP/cert_key

      - name: "Install the Apple provisioning profile(Codesigning)"
        env:
          APP_STORE_CONNECT_KEY_IDENTIFIER: ${{ secrets.APP_STORE_CONNECT_KEY_IDENTIFIER }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
        run: |
          app-store-connect fetch-signing-files com.tokeru.macos.prod \
            --platform MAC_OS \
            --type MAC_APP_STORE \
            --certificate-key=@file:$RUNNER_TEMP/cert_key \
          app-store-connect fetch-signing-files com.tokeru.macos.prod \
            --platform MAC_OS \
            --type MAC_APP_DEVELOPMENT \
            --certificate-key=@file:./cert_key \
            --create

      - name: "Install the Apple provisioning profile(Distribution)"
        env:
          APP_STORE_CONNECT_KEY_IDENTIFIER: ${{ secrets.APP_STORE_CONNECT_KEY_IDENTIFIER }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
        run: |
          app-store-connect list-certificates \
            --type MAC_INSTALLER_DISTRIBUTION \
            --certificate-key=@file:$RUNNER_TEMP/cert_key \
            --save

      - name: "keychain initialize"
        run: keychain initialize

      - name: "keychain add-certificates"
        run: keychain add-certificates

      - name: "xcode-project use-profiles"
        run: xcode-project use-profiles

      - name: Build macOS app
        env:
          APP_STORE_CONNECT_KEY_IDENTIFIER: ${{ secrets.APP_STORE_CONNECT_KEY_IDENTIFIER }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
        run: |
          build_number=$(app-store-connect get-latest-build-number 6479510993) 
          new_build_number=$((build_number + 1))
          flutter build macos --dart-define-from-file=dart_defines/prod.json

      - name: "package macOS app"
        run: |
          APP_NAME=$(find $(pwd) -name "*.app")
          PACKAGE_NAME=$(basename "$APP_NAME" .app).pkg
          xcrun productbuild --component "$APP_NAME" /Applications/ unsigned.pkg
          INSTALLER_CERT_NAME=$(keychain list-certificates \
                    | jq '[.[]
                      | select(.common_name
                      | contains("Mac Developer Installer"))
                      | .common_name][0]' \
                    | xargs)
          xcrun productsign --sign "$INSTALLER_CERT_NAME" unsigned.pkg "$PACKAGE_NAME"
          rm -f unsigned.pkg

      - name: "upload TestFlight"
        run: app-store-connect publish --path "$PACKAGE_NAME" --testflight --beta-group=group01 --expire-build-submitted-for-review
